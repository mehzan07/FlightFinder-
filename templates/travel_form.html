<!DOCTYPE html>
<html>
<head>
    <title>Travel Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
</head>
<body class="bg-light" style="background: linear-gradient(to right, #e0f7fa, #fff);">

<div class="container mt-5">
    <h2 class="mb-1">✈️ Plan Your Trip</h2>
    <p class="text-muted mb-4">Find the best flights, fast.</p>

    {% if errors %}
    <div class="alert alert-danger">
        <h5 class="mb-2">⚠️ Please fix the following:</h5>
        <ul class="mb-0">
            {% for error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="POST" action="/travel-ui" class="card p-4 shadow-sm">
            <!-- Origin City -->
        <div class="mb-3">
        <label for="origin_city" class="form-label">From (City)</label>
        <input type="text" class="form-control" id="origin_city" name="origin_city"
                value="{{ form_data.origin_city if form_data else 'Stockholm' }}"
                placeholder="Enter origin city" />
        </div>

        <!-- Origin Code (Full Name + Code) -->
        <div class="mb-3">
        <label for="origin_code" class="form-label">Origin Airport</label>
        <input type="text" class="form-control" id="origin_code" name="origin_code"
                value="{{ form_data.origin_code if form_data else 'Stockholm Arlanda (ARN)' }}"
                placeholder="e.g. Stockholm Arlanda (ARN)" />
        </div>

        <!-- Destination City -->
        <div class="mb-3">
        <label for="destination_city" class="form-label">To (City)</label>
        <input type="text" class="form-control" id="destination_city" name="destination_city"
                value="{{ form_data.destination_city if form_data else 'London' }}"
                placeholder="Enter destination city" />
        </div>

        <!-- Destination Code (Full Name + Code) -->
        <div class="mb-3">
        <label for="destination_code" class="form-label">Destination Airport</label>
        <input type="text" class="form-control" id="destination_code" name="destination_code"
                value="{{ form_data.destination_code if form_data else 'London Heathrow (LHR)' }}"
                placeholder="e.g. London Heathrow (LHR)" />
        </div>
        <div class="mb-3">
            <label class="form-label" for="trip_type">🧭 Trip Type</label>
            <select id="trip_type" name="trip_type" class="form-select">
                <option value="round-trip" {% if not form_data or form_data.trip_type == 'round-trip' %}selected{% endif %}>Round Trip</option>
                <option value="one-way" {% if form_data and form_data.trip_type == 'one-way' %}selected{% endif %}>One Way</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label" for="date_from">📅 Departure Date</label>
            <input type="date" id="date_from" name="date_from" class="form-control" required
                   value="{{ session.last_search.departure if session.last_search else form_data.date_from if form_data else '2025-10-10' }}">
        </div>

        <div class="mb-3" id="arrivalDateGroup"
             style="{% if form_data and form_data.trip_type == 'one-way' %}display:none;{% endif %}">
            <label class="form-label" for="date_to">📅 Arrival Date</label>
            <input type="date" id="date_to" name="date_to" class="form-control"
                   value="{{ session.last_search.arrival if session.last_search else form_data.date_to if form_data and form_data.trip_type == 'round-trip' else '2025-10-17' }}"
                   {% if not form_data or form_data.trip_type == 'round-trip' %}required{% endif %}>
        </div>

        <div class="mb-3">
            <label class="form-label" for="passengers">👥 Passengers</label>
            <input type="number" id="passengers" name="passengers" class="form-control" min="1" required
                   value="{{ form_data.passengers if form_data else 1 }}">
        </div>

        <div class="mb-3">
            <label class="form-label" for="cabin_class">💺 Cabin Class</label>
            <select id="cabin_class" name="cabin_class" class="form-select" required>
                <option value="economy" {% if not form_data or form_data.cabin_class == 'economy' %}selected{% endif %}>Economy</option>
                <option value="business" {% if form_data and form_data.cabin_class == 'business' %}selected{% endif %}>Business</option>
                <option value="first" {% if form_data and form_data.cabin_class == 'first' %}selected{% endif %}>First</option>
            </select>
        </div>

        <div id="loading" class="text-center mb-3" style="display:none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Searching flights...</p>
        </div>

        <!-- Max Flights to Show -->
        <div class="mb-3">
            <label for="limit" class="form-label">Max Flights to Show</label>
            <select class="form-select" name="limit" id="limit">
                <option value="8" {% if form_data.limit == "8" %}selected{% endif %}>8</option>
                <option value="16" {% if form_data.limit == "16" %}selected{% endif %}>16</option>
                <option value="32" {% if form_data.limit == "32" %}selected{% endif %}>32</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Search Flights</button>

        {% if flights %}
        <div class="mt-5">
            <h4>🛫 Available Flights</h4>
            <div class="row">
                {% for flight in flights %}
                <div class="col-md-6">
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">{{ flight.airline }}</h5>
                            <p class="card-text">
                                {{ flight.depart }}{% if flight.arrival %} → {{ flight.arrival }}{% endif %}<br>
                                Price: €{{ flight.price }}
                            </p>
                            {% if flight.link %}
                                <a href="{{ flight.link }}" class="btn btn-outline-primary" target="_blank">Book Now</a>
                            {% else %}
                                <span class="text-muted">No booking link available</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
    const airports = [
        "Stockholm Arlanda (ARN)", "Stockholm Bromma (BMA)", "Tokyo Haneda (HND)", "Tokyo Narita (NRT)",
        "London Heathrow (LHR)", "Paris Charles de Gaulle (CDG)", "New York JFK (JFK)", "Dubai (DXB)",
        "Bangkok Suvarnabhumi (BKK)", "Toronto Pearson (YYZ)", "Copenhagen Kastrup (CPH)", "Rome Fiumicino (FCO)"
    ];

    $(function() {
        $("#origin_code").autocomplete({ source: airports });
        $("#destination_code").autocomplete({ source: airports });
    });

    document.addEventListener("DOMContentLoaded", () => {
        const dateFrom = document.getElementById("date_from");
        const dateTo = document.getElementById("date_to");
        const tripType = document.getElementById("trip_type");
        const arrivalDateGroup = document.getElementById("arrivalDateGroup");

        if (dateFrom && dateTo) {
            const today = new Date().toISOString().split("T")[0];
            dateFrom.min = today;

            dateFrom.addEventListener("change", () => {
                dateTo.min = dateFrom.value;
            });
        }

        const toggleReturnDate = () => {
            if (tripType.value === "one-way") {
                arrivalDateGroup.style.display = "none";
                dateTo.required = false;
                dateTo.value = "";
            } else {
                arrivalDateGroup.style.display = "block";
                dateTo.required = true;
            }
        };
        tripType.addEventListener("change", toggleReturnDate);
        toggleReturnDate();

        const form = document.querySelector("form");
        const loading = document.getElementById("loading");

        if (form && loading) {
            form.addEventListener("submit", (event) => {
                event.preventDefault();
                loading.style.display = "block";
                setTimeout(() => {
                    form.submit();
                }, 500);
            });
        }
    });
</script>
</body>
</html>